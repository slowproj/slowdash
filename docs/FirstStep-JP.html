<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SlowDash を使ってみる</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

<header>
<div class="title">SlowDash を使ってみる</div><p>
<div class="toc">
<span class="toc-title">Contents</span>
<nav id="TOC">
<ul>
<li><a href="#slowdash-とは" id="toc-slowdash-とは">SlowDash
とは</a></li>
<li><a href="#インストール" id="toc-インストール">インストール</a></li>
<li><a href="#ダミーデータで-ui-を動かしてみる"
id="toc-ダミーデータで-ui-を動かしてみる">ダミーデータで UI
を動かしてみる</a></li>
<li><a href="#quick-tour-をやってみる"
id="toc-quick-tour-をやってみる">Quick Tour をやってみる</a></li>
<li><a href="#docker-コンテナで使う"
id="toc-docker-コンテナで使う">Docker コンテナで使う</a></li>
<li><a href="#slowdash-のアップデート"
id="toc-slowdash-のアップデート">SlowDash のアップデート</a>
<ul>
<li><a href="#直接インストール"
id="toc-直接インストール">直接インストール</a></li>
<li><a href="#docker-コンテナ" id="toc-docker-コンテナ">Docker
コンテナ</a></li>
</ul></li>
<li><a href="#動作確認用テスト環境"
id="toc-動作確認用テスト環境">動作確認用テスト環境</a></li>
<li><a href="#セキュリティについて"
id="toc-セキュリティについて">セキュリティについて</a></li>
<li><a href="#リバースプロキシ"
id="toc-リバースプロキシ">リバースプロキシ</a></li>
</ul>
</nav>
</div>
</header>

<h1 id="slowdash-とは">SlowDash とは</h1>
<p>スローコントロールのダッシュボードを Grafana
で作らされた経験に基づいて開発が開始されました．おおまかには，</p>
<ul>
<li>Grafana
みたいに，データベース上にあるデータ（主に時系列）をリアルタイムにビジュアライズする</li>
<li>LabVIEW
のパネルみたいに，画面上にいろいろ並べて，デバイスの状態を一覧表示したり，マウス等で操作したりする</li>
<li>ROOT
みたいなデータ型（ヒストグラムとか誤差つきグラフとか）を直接扱う</li>
<li>Jyputer に接続して収集中のデータを対話的に解析する</li>
<li>Python スクリプトを組み込んで機器制御やリアルタイム処理をする</li>
</ul>
<p>ための Web ベースのソフトウェアです．ブラウザ側の JavaScript
と，サーバー側の Python で構成されています．</p>
<p>もともとはスローコントロール用でしたが，現在では物理実験に関わる全てのデータのビジュアライズと，DAQ
を含むシステムコントロールの UI
を目指して開発をしています．現時点で，Grafana
で行うようなビジュアライゼーションの部分はほぼ実装済みで，解析およびコントロールの部分が開発中です．</p>
<p>データベースアクセス以外は外部ライブラリを使っておらず，ソフトウェアの寿命が外のライブラリの変更等に影響されることはないようになっています．特に，流行り廃れが激しい
JavaScript
の部分はフレームワークなどは使わず，完全に自己完結です（使っていたけど排除しました）．データベース側および解析モジュールは，全て独立なプラグインとなっており，いつでも切り捨てられます．依存性がないので，インストールがとても楽で，使用後も痕跡を残さずきれいに削除できます．それでもインストールをしたくない人のために，すぐに使える
Docker コンテナも提供されています．</p>
<p><img src="fig/Gallery-ATDS-Dashboard.png" style="width:40%;box-shadow:0px 0px 15px -5px rgba(0,0,0,0.7);">
<img src="fig/Gallery-RGA.png" style="width:40%;box-shadow:0px 0px 15px -5px rgba(0,0,0,0.7);"></p>
<h3 id="機能と特長予定を含む">機能と特長（予定を含む）</h3>
<p>Grafana と似たビジュアライゼーション（ほぼ実装済み）</p>
<ul>
<li>実時間で更新していくプロットと，過去のデータの表示</li>
<li>物理実験で使われているデータベースはだいたい使える．なくてもプラグインで追加は簡単．
<ul>
<li>SQL データベース: PostgreSQL, MySQL, SQLite</li>
<li>時系列データベース： InfluxDB</li>
<li>キーバリューストア： Redis</li>
<li>ドキュメントデータベース： MongoDB, CouchDB</li>
</ul></li>
<li>実験ですでに使われているいろいろなデータ形式（スキーマ）に，時系列データならほぼ全て対応できる．</li>
<li>誰でもブラウザから対話的にプロットを構成できる．作ったものは保存して共有できる．</li>
</ul>
<p>Grafana
と違って，物理屋に使いやすいようになっています（ほぼ実装済み）:</p>
<ul>
<li>ズームや表示範囲の変更が簡単</li>
<li>対数軸への切り替えが簡単</li>
<li>新しいプロットをすぐに作れる</li>
<li>URL からプロットを構成できる →
いろんなプロットへのリンクをたくさん作れる</li>
<li>ヒストグラムやエラーバー付きグラフも直接サポート</li>
<li>時系列以外のデータも普通に扱える</li>
<li>何も考えずに長期間のデータを表示してもブラウザがデータを溜め込まない</li>
<li>表示範囲のデータを簡単に CSV 等でダウンロードできる</li>
<li>表示プロットを Jypyter にエクスポートして解析を継続できる</li>
</ul>
<p>さらに，コントロール用の機能も実装しています（８割くらい完成）:</p>
<ul>
<li>サーバー側にユーザの Python
コードを置いて，ブラウザからコマンドを送れる</li>
<li>サーバー側のユーザ Python
コードが動的に生成したデータもストリーミング表示できる</li>
<li>ブラウザ上でも簡単なデータ加工が行える</li>
<li>ユーザ作成の任意の HTML コードを組み込める</li>
</ul>
<p>将来的には，</p>
<ul>
<li>サーバー側での継続的データ処理とアラーム</li>
<li>データベース以外からのデータのビジュアライズ（ROOT
ファイルとか，どっかのストリーミングとか）</li>
<li>ヒストグラムのフィティング等まで含めた埋め込みおよび対話的データ解析</li>
<li>メッセージングシステムへの直接接続 (AMQP とか Kafka とか)</li>
</ul>
<p>Grafana にあって今の SlowDash
にないもの（将来は実装されるかも）：</p>
<ul>
<li>柔軟なレイアウト構成</li>
<li>円グラフ，重ね棒グラフ，みんな使ってる丸いゲージ，Excel
によくあるチャート，…</li>
<li>地理データ表示（世界地図を塗り分けるとか；SlowDash
でもできるけど地図がない）</li>
<li>データベース等の設定ファイルのブラウザからの構築</li>
<li>ユーザ管理，アクセス管理</li>
</ul>
<p>実験でよく使われるけど，今の SlowDash にないもの：</p>
<ul>
<li>３次元の絵</li>
<li>トラックとかを描くイベントディスプレイ（描画要素の数が毎回変わるもの）</li>
</ul>
<p>JSROOT や Streamlit，Bokeh との違い：</p>
<ul>
<li><p>SlowDash と Grafana にあるけど JSROOT/Streamlit/Bokeh
にない機能</p>
<ul>
<li>コーディングなし：マウス数回のクリックでデータベース上のデータを可視化</li>
<li>データを見るユーザが自分でブラウザ上でプロットを作成し，保存・共有できる</li>
</ul></li>
<li><p>SlowDash と LabVIEW UI にあるけど JSROOT/Bokeh にない機能</p>
<ul>
<li>装置の構成図の上にデータを表示して，デバイスを操作できる</li>
<li>たくさんのユーザ入力を受け取るフォームを作れる</li>
</ul></li>
<li><p>数値データでなくても良い．ログメッセージとか，ステータス一覧とか，写真とか</p></li>
<li><p>JSROOT や Bokeh でできて，今の SlowDash
にないけど，やりたいこと（できる気がするもの）</p>
<ul>
<li>動いている ROOT の中身をリアルタイムにビジュアライズ</li>
<li>Jupyter
でブラウザからサーバー側の解析コードを書いて，テストして，そのままデプロイ</li>
<li>(動いている Python/Matplotlib
の中身(Figure)を抜き出してリアルタイムにビジュアライズすることはすでにできます）</li>
</ul></li>
</ul>
<h3 id="よくある宣伝">よくある宣伝</h3>
<p>みんな書いているので，いちおう書いておきます．</p>
<ul>
<li>MVC アーキテクチャに基づいています．</li>
<li>Web API は全て RESTful です．</li>
<li>UI はレスポンシブです．</li>
<li>プラグインで機能拡張できます．</li>
<li>クラウドネイティブな設計です．</li>
<li>オープンソースです．</li>
<li>最新のユーザー体験を提供します．</li>
<li>高度なデータ統合で DX を推進します．</li>
</ul>
<h1 id="インストール">インストール</h1>
<h3 id="サーバー側動作環境">サーバー側動作環境</h3>
<h4 id="docker">Docker</h4>
<p>Docker があれば，DockerHub または GitHub CR にある SlowDash
のイメージがすぐに利用できます (Linux / Windows WSL / MacOS)．</p>
<ul>
<li>Docker Hub: <a
href="https://hub.docker.com/r/slowproj/slowdash">https://hub.docker.com/r/slowproj/slowdash</a></li>
<li>GitHub CR: <a
href="https://github.com/slowproj/slowdash/pkgs/container/slowdash">https://github.com/slowproj/slowdash/pkgs/container/slowdash</a></li>
</ul>
<p>ただ，最初から Docker
を使うと設定ファイルの扱いなどが面倒だと思います．ここでは，Docker
を使う手順を最後に解説します．</p>
<h4 id="標準インストール">標準インストール</h4>
<p>基本的に Python 3 が動けばすぐ使えます．</p>
<ul>
<li>UNIX 風の OS．Ubuntu で開発，macOS とか Windows の WSL
でも動いた．WinPython でも動くらしい．</li>
<li>Python 3.9 以上と venv</li>
</ul>
<p>ここでのインストールでは，venv
を使用してそこに必要なパッケージを自動インストールするので，手動で
Python のパッケージなどを準備する必要はありません．(venv
を使わずにインストールすることもできます．)</p>
<h3 id="ウェブブラウザ">ウェブブラウザ</h3>
<p>Firefox で開発していて，たまに Chrome と Edge と Safari
でテストしています．タブレットや携帯などのモバイルデバイス上でもそこそこ動作します（プロットの移動やズームは二本指です）．</p>
<h3 id="ダウンロード">ダウンロード</h3>
<p>GitHub からダウンロードできます．
サブモジュールを使っているので，<code>--recurse-submodules</code>
オプションをつけてください．</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ git clone https://github.com/slowproj/slowdash.git --recurse-submodules</span></span></code></pre></div>
<p>(<code>git</code> コマンドが利用できない場合，<a
href="https://github.com/slowproj/slowdash">github のページ</a>
からパッケージをダウンロードすることもできます．）</p>
<p>これで，<code>slowdash</code>
というディレクトリが作成されます．インストールおよび次の Quick Tour
では，全てのファイルは slowdash
のディレクトリ以下に作られるので，この過程でユーザのシステムが汚されることはありません．また，このディレクトリを削除すれば，全てをなかったことにできます．</p>
<h3 id="ドキュメント">ドキュメント</h3>
<p>公式ドキュメントは，展開したディレクトリの <code>docs</code>
以下にあります．<code>index.html</code> をブラウザで開いてください．</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ firefox slowdash/docs/index.html</span></span></code></pre></div>
<p>（macOS 等では，<code>firefox</code>
コマンドを直接実行するのではなく，<code>open</code>
コマンドを介するようです．）</p>
<p>日本語の隠しドキュメントは <code>FirstStep-JP.html</code>
です．今読んでいるものですが，<code>docs</code>
から読むと内部リンクが切れていません．</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ firefox slowdash/docs/FirstStep-JP.html</span></span></code></pre></div>
<h3 id="インストール-1">インストール</h3>
<div class="sourceCode" id="cb4"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd slowdash</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ make</span></span></code></pre></div>
<p>これで，Python 周りのセットアップと，作成した venv
へのパッケージのインストールを行います．</p>
<p>venv を使わない場合は，最後の <code>make</code> の代わりに
<code>make without-venv</code> としてください．もし間違えて
<code>make</code> してしまった場合は，<code>slowdash</code>
ディレクトリの下にある <code>venv</code>
ディレクトリを削除すれば同じになります．SlowDash
の実行に必要なパッケージの <code>requirements.txt</code>
ファイルも自動生成されるので，venv
を使わない場合はこれを手動でインストールしてください（<code>pip install -r requirements.txt</code>）．</p>
<p>以上により，<code>slowdash/bin</code>
の下にシェルの設定するスクリプト <code>slowdash-bashrc</code>
ができるので，これを <code>source</code> してください．</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ source PATH/TO/SLOWDASH/bin/slowdash-bashrc</span></span></code></pre></div>
<p>ちなみに中身はこんな感じです．</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">SLOWDASH_DIR</span><span class="op">=</span>/PATH/TO/SLOWDASH</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">alias</span> slowdash=<span class="st">&quot;</span><span class="va">$SLOWDASH_DIR</span><span class="st">/bin/slowdash&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">alias</span> slowdash-activate-venv=<span class="st">&quot;source </span><span class="va">$SLOWDASH_DIR</span><span class="st">/venv/bin/activate&quot;</span></span></code></pre></div>
<p>設定ファイルの <code>source</code>
は，新しいターミナルを開くたびに毎回必要です． SlowDash
を継続的に使うなら，上記の source コマンドを <code>.bashrc</code> (Mac
では <code>.zshrc</code>)
などに書いておくと毎回やる必要がなくなります．なお，複数のバージョンの
SlowDash インストールを使い分けるなら，上記の source
だけで全てを切り替えることができます．</p>
<p>インストールが成功したかは，<code>slowdash</code>
コマンドを実行してチェックできます． (<code>slowdash</code> コマンドは
<code>slowdash/bin</code> の下にあります）</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>Running in venv at /PATH/TO/SLOWDASH/venv</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>usage: </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  Web-Server Mode:      slowdash.py [Options] --port=PORT</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  Command-line Mode:    slowdash.py [Options] COMMAND</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>Slowdash Version 250128 &quot;Skykomish&quot;</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>positional arguments:</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  COMMAND               API query string. Ex) &quot;config&quot;, &quot;channels&quot;, &quot;data/CHANNELS?length=LENGTH&quot;</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>options:</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  -h, --help            show this help message and exit</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  -p PORT, --port PORT  port number for web connection; command-line mode without this option</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  --project-dir PROJECT_DIR</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                        project directory (default: current dir if not specified by SLOWDASH_PROJECT environmental</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>                        variable)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p>任意のポート番号を指定して <code>slowdash</code>
コマンドを実行し，ブラウザとの接続を確認してください．ここで，プロジェクトがないという警告が出ますが，今はこのまま先に進みます．</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash --port=18881</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>23-05-15 20:12:35 WARNING: unable to find Slowdash Project Dir: specify it with the --project-dir option, set the SLOWDASH_PROJECT environmental variable, or run the slowdash commands at a project directory</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>listening at port 18881</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ firefox http://localhost:18881</span></span></code></pre></div>
<p>成功すれば以下のようなエラーメッセージが表示されます．</p>
<p><img src="fig/QuickTour-Welcome.png" style="width:40%"></p>
<p>確認したら，<code>Ctrl-c</code> で <code>slowdash</code>
コマンドを終了してください．</p>
<h3 id="アップデート">アップデート</h3>
<p>アップデートは，<code>make</code> で行うのが簡単です．</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ make update</span></span></code></pre></div>
<p>あるいは，以下のように手動で行っても構いませんが，<code>--recurse-submodules</code>
をつけるのを忘れないようにしてください：</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ git pull --recurse-submodules</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">$ make</span></span></code></pre></div>
<p>アップデート直後は，ブラウザのキャッシュに古いスクリプトが残っていることがあります．動作がおかしい場合は，<code>Ctrl</code>-<code>F5</code>
など（ブラウザにより微妙に異なる）で強制リロードを行ってください．（状況が許すなら，キャッシュの全削除をするのが確実です．すいません．この問題はいずれちゃんと対応します．）</p>
<h1 id="ダミーデータで-ui-を動かしてみる">ダミーデータで UI
を動かしてみる</h1>
<p>ダミーデータを使って SlowDash の UI
をテストするプロジェクトがあるので，これを使ってとりあえず動かしてみます．展開した
SlowDash ディレクトリの下にある <code>ExampleProjects</code> の
<code>DummyDataSource</code> に <code>cd</code> して，そこから
<code>slowdash</code> を走らせてください．</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH/ExampleProjects/DummyDataSource</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash --port=18881</span></span></code></pre></div>
<p>プラウザを立ち上げて <code>http://localhost:18881</code>
に接続すると作成済みページの一覧が表示されます．右上の SlowPlot にある
<code>demo</code>
をクリックすると，以下のようなプロットのデモページが表示されます．データに意味はなく，更新するたびに中身が変わりますが，SlowDash
の表示要素の操作を一通り試してみることができます．</p>
<p><img src="fig/QuickTour-DummyDataSource.png" style="width:40%"></p>
<h1 id="quick-tour-をやってみる">Quick Tour をやってみる</h1>
<p>ここでは，公式ドキュメントの Quick Tour
の前半くらい，時系列データのプロットを作るところまでやってみます．</p>
<p>テスト用のデータストアには，SQLite
を使います．これは，追加のライブラリをインストールせずに使用でき，また，データがファイルに保存されるため，使用後のクリーンアップが簡単なためです．</p>
<p>最初に，プロジェクト用のディレクトリを作成してください．ディレクトリを作る場所はどこでもいいです．このプロジェクトで作成されるファイルは全てこのディレクトリ以下に格納されます．プロジェクト終了後はディレクトリをまるごと削除しても大丈夫です．途中でプロジェクトディレクトリを別の場所へ移動することも可能です．</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ mkdir QuickTour</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd QuickTour</span></span></code></pre></div>
<h3
id="準備slowpy-ライブラリを使ってテスト用のデータストアを作る">準備：SlowPy
ライブラリを使ってテスト用のデータストアを作る</h3>
<p>SlowPy は，SlowDash に含まれる Python
のユーザライブラリ部分です．上記のインストールで，<code>source slowdash/bin/slowdash-bashrc</code>
をしていれば，<code>slowdash-activate-venv</code> で SlowDash の venv
に入れます（手動で activate しても構いません）．</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash-activate-venv       (または source PATH/TO/SLOWDASH/venv/bin/activate)</span></span></code></pre></div>
<p>インストール時に venv を使わなかった場合
(<code>pip install -r requrements.txt</code>した場合)は，この手順は必要ありません．venv
から抜ける場合は，端末を閉じるか，<code>deactivate</code>
コマンドを使ってください．</p>
<p>SlowPy を使って，一秒ごとに乱数の値を SQLite
に書き込むスクリプトを作成します．</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> ControlSystem, RandomWalkDevice</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.store <span class="im">import</span> DataStore_SQLite, LongTableFormat</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TestDataFormat(LongTableFormat):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    schema_numeric <span class="op">=</span> <span class="st">&#39;(datetime DATETIME, timestamp INTEGER, channel VARCHAR(100), value REAL, PRIMARY KEY(timestamp, channel))&#39;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> insert_numeric_data(<span class="va">self</span>, cur, timestamp, channel, value):</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        cur.execute(<span class="ss">f&#39;INSERT INTO </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>table<span class="sc">}</span><span class="ss"> VALUES(CURRENT_TIMESTAMP,%d,?,%f)&#39;</span> <span class="op">%</span> (timestamp, value), (channel,))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>ctrl <span class="op">=</span> ControlSystem()</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> RandomWalkDevice(n<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>datastore <span class="op">=</span> DataStore_SQLite(<span class="st">&#39;sqlite:///QuickTourTestData.db&#39;</span>, table<span class="op">=</span><span class="st">&quot;testdata&quot;</span>, table_format<span class="op">=</span>TestDataFormat())</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _loop():</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">4</span>):</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> device.read(ch)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        datastore.append(data, tag<span class="op">=</span><span class="st">&quot;ch</span><span class="sc">%02d</span><span class="st">&quot;</span><span class="op">%</span>ch)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    ctrl.sleep(<span class="dv">1</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _finalize():</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    datastore.close()</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    ctrl.stop_by_signal()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> ctrl.is_stop_requested():</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        _loop()</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    _finalize()</span></code></pre></div>
<p>このスクリプトの詳細は公式ドキュメントの <a
href="ControlsScript.html">Controls
セクション</a>に説明があります．ここでは，上記の内容をコピペして，<code>generate-testdata.py</code>
というファイル名でプロジェクトディレクトリに保存してください．</p>
<p>このスクリプトを走らせると，テスト用のデータファイルが生成されます．</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ python generate-testdata.py</span></span></code></pre></div>
<p>（もしコピペに失敗してエラーが出るようであれば，同じ内容のファイルが
<code>slowdash/ExampleProjects/QuickTour/config/slowtask-testdata.py</code>
にあります．）</p>
<p>10 秒くらい経過したら <code>Ctrl</code>-<code>c</code>
で止めて，できたファイルを確認してください．</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ ls -l</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>-rw-r--r-- 1 sanshiro sanshiro 24576 Apr 11 16:52 QuickTourTestData.db</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>-rwxr-xr-x 1 sanshiro sanshiro  3562 Apr 11 16:51 generate-testdata.py</span></code></pre></div>
<p>データの中身は <code>sqlite3</code>
コマンドで確認できます．（このコマンドがインストールされてなければ，この手順は飛ばしていいです．）</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ sqlite3 QuickTourTestData.db </span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>SQLite version 3.31.1 2020-01-27 19:55:54</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>Enter &quot;.help&quot; for usage hints.</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>sqlite&gt; .table</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>testdata</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>sqlite&gt; .schema testdata</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>CREATE TABLE testdata(datetime DATETIME, timestamp INTEGER, channel VARCHAR(100), value REAL, PRIMARY KEY(timestamp, channel));</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>sqlite&gt; select * from testdata limit 10;</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>2023-04-11 23:52:13|1681257133|ch00|0.187859</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>2023-04-11 23:52:13|1681257133|ch01|-0.418021</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>2023-04-11 23:52:13|1681257133|ch02|0.482607</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>2023-04-11 23:52:13|1681257133|ch03|1.733749</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<p><code>sqlite3</code> の <code>.schema</code>
コマンド出力にあるとおり，データは <code>testdata</code>
というテーブルに保存されていて，その構造は以下のようになっています．</p>
<pre><code>testdata(datetime DATETIME, timestamp INTEGER, channel VARCHAR(100), value REAL, PRIMARY KEY(timestamp, channel))</code></pre>
<p>テスト目的のために，データのタイムスタンプは日付時刻型（SQLite では
ISO 表記の文字列）のものと，整数の UNIX
時間の両方が入っていますが，通常はどちらか一方のことが多いと思います．SQLite
では，タイムゾーンの扱いに罠が多いので，UNIX
時間の方がいいかもしれません．</p>
<p>データの中身はこんな感じです:</p>
<table>
<colgroup>
<col style="width: 21%" />
<col style="width: 26%" />
<col style="width: 26%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="header">
<th>datetime (DATETIME/TEXT)</th>
<th>timestamp (INTEGER)</th>
<th>channel (VARCHAR(100))</th>
<th>value (REAL)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2023-04-11 23:52:13</td>
<td>1681257133</td>
<td>ch00</td>
<td>0.187859</td>
</tr>
<tr class="even">
<td>2023-04-11 23:52:13</td>
<td>1681257133</td>
<td>ch01</td>
<td>-0.418021</td>
</tr>
<tr class="odd">
<td>2023-04-11 23:52:13</td>
<td>1681257133</td>
<td>ch02</td>
<td>0.482607</td>
</tr>
<tr class="even">
<td>2023-04-11 23:52:13</td>
<td>1681257133</td>
<td>ch03</td>
<td>1.733749</td>
</tr>
<tr class="odd">
<td>…</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>ここでは，面倒な例として，日付時刻型のデータにタイムゾーンを明示しないで
UTC 時刻を使用しています（SQLite
ではこれがデフォルトの関数が多いです）．通常は，タイムゾーン付きまたは
UNIX 時間を使用してください．</p>
<p>時系列データのテーブルは，必ずしもこの形になっている必要はありません．特に，テーブルにカラムを追加するのが簡単なタイプのデータストアを使用している場合は，各チャンネルを各カラムにするのも普通にアリだと思います．同時に読み出したデータのグルーピングが簡単になるというメリットもあります．詳しくは，公式ドキュメントの
<a href="DataBinding.html">Data Binding</a> の章を参照してください．</p>
<h3 id="プロジェクト設定">プロジェクト設定</h3>
<p>SlowDash のプロジェクトでは，通常，専用のディレクトリを作って，そこに
<code>SlowdashProject.yaml</code>
という名前のプロジェクト設定ファイルを置きます．（データファイルを直接読む場合などの例外はあります．）どこのデータベースからどのようなデータを読むかなどを，このプロジェクト設定ファイルに記述します．</p>
<p>プロジェクトディレクトリに，以下の内容で
<code>SlowdashProject.yaml</code>
という名前のファイルを作成してください．</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">slowdash_project</span><span class="kw">:</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">name</span><span class="kw">:</span><span class="at"> QuickTour   (なんでも良いが，スペースや特殊文字を含まない方が人生が楽になる)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">title</span><span class="kw">:</span><span class="at"> SlowDash Quick Tour  （なんでも良いが，改行や極悪な文字は含まない方がいいと思う）</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">data_source</span><span class="kw">:</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> SQLite</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">file</span><span class="kw">:</span><span class="at"> QuickTourTestData.db</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">time_series</span><span class="kw">:</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">schema</span><span class="kw">:</span><span class="at"> testdata[channel]@timestamp(unix)=value</span></span></code></pre></div>
<p><code>schema</code>
のところで，データのテーブル名と，どの情報がどのカラムに書かれているかを記述しています．フォーマットは，<code>テーブル名 [チャンネル情報のカラム名] @ 時刻情報のカラム名（時刻の表現形式）= データ値のカラム名</code>
みたいな感じです．詳しくは，<a href="DataBinding.html">DataBinding</a>
の章を参照してください．</p>
<p>この例では，時刻情報に，UNIX
タイムスタンプの方を使っています．DateTime
型の方の時刻情報を使う場合は，<code>schema</code>
の記述を以下のようにしてください：</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">time_series</span><span class="kw">:</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">schema</span><span class="kw">:</span><span class="at"> testdata[channel]@datetime(unspecified utc)=value</span></span></code></pre></div>
<p>ここでは，UTC
時刻がタイムゾーン指定なしで使われている悪い例に対応するために，時刻表現形式を
<code>unspecified utc</code> (「書いてないけど UTC
だよ」)と伝えています．保存されているデータがちゃんとタイムゾーン付きの場合は
<code>with timezone</code> または <code>aware</code>
を，最悪のケースでタイムゾーンなしでローカルタイムが使われている場合は
<code>without timezone</code> または <code>naive</code>
と書いてください．この情報は，SlowDash
がクエリを構築する際に，データと同じ時刻表現を使用するために使われます．タイムゾーンを明示しないでローカルタイムを使った場合の惨事が多数報告されているので，新しく作るデータで
<code>without timezone</code>
を選択する理由はないです．（日本国内だけなら関係ないと思ってすでにそういう形式でデータを取ってる場合は，夏時間の導入に反対しておいた方がいいです．）</p>
<p><code>slowdash config</code>
コマンドで設定情報の一部が表示されるので，設定ファイルが読めているかのチェックができます．これは，<code>SlowdashProject.yaml</code>
ファイルを作成したプロジェクトディレクトリで実行してください．</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash config</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    &quot;project&quot;: {</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>        &quot;name&quot;: &quot;QuickTour&quot;,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        &quot;title&quot;: &quot;SlowDash Quick Tour&quot;,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        &quot;error_message&quot;: &quot;&quot;</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    &quot;data_source_module&quot;: [</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        &quot;datasource_SQLite.py&quot;</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    &quot;user_module&quot;: [],</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    &quot;style&quot;: null</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>データベースに正しくアクセスできる場合，<code>slowdash channels</code>
コマンドでチャンネルの一覧を表示できます．</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash channels</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  {&quot;name&quot;: &quot;ch00&quot;}, {&quot;name&quot;: &quot;ch01&quot;}, {&quot;name&quot;: &quot;ch02&quot;}, ...</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p>データの中身は，<code>slowdash data/CHANNEL</code>
コマンドで見ることができます．</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash &quot;data/ch00?length=10&quot;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  &quot;ch00&quot;: {</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    &quot;start&quot;: 1680223465, &quot;length&quot;: 10, </span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    &quot;t&quot;: [0.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0], </span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    &quot;x&quot;: [5.180761, 5.92074, 5.515459, 4.883299, 5.650556, 4.284527, 3.884656, 3.223627, 2.06343]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>もう気づいたかもしれませんが，<code>slowdash</code>
コマンドの第１引数は HTTP でアクセスした場合の URL
で，出力はそのリプライです．</p>
<h3 id="サーバーを走らせる">サーバーを走らせる</h3>
<p>SlowDash にネットワークからアクセスするために，<code>--port</code>
オプションで適当なポート番号を指定します．これで，コマンドを HTTP
経由で受け取るようになります．</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash --port=18881</span></span></code></pre></div>
<p>SlowDash
を走らせたままブラウザを立ち上げ，使ったポートに接続してください．</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ firefox http://localhost:18881</span></span></code></pre></div>
<p>今回はプロジェクト付きで走らせているので，以下のようなスタートページが表示されるはずです．</p>
<p><img src="fig/QuickTour-Home.png" style="width:40%"></p>
<p>テスト用のデータベースにデータを継続的に記録するため，別ターミナルで先程のデータ生成プログラムを走らせてください．</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>(別ターミナルを開く)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/MySlowDashProject</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash-activate-venv</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="kw">$ python ./generate-testdata.py</span></span></code></pre></div>
<p>データサイズは一時間で 5MB
程度なので，しばらくは走らせ続けて大丈夫です．データファイル（<code>QuickTourTestData.db</code>）は，SlowDash
が走ってなければ，いつ消しても構いません．またデータが欲しくなったら，再度
<code>generate-testdata.py</code>
を走らせてください．（データファルを削除せずに走らせても問題ありません．複数同時に走らせたら変なことになると思います．）</p>
<p>プログラムの終了は，全て <code>Ctrl</code>-<code>c</code>
です．それなりに上品に止まります．だめだったら，<code>Ctrl</code>-<code>\</code>
を使ってください．</p>
<h3 id="ブラウザでデータを見る">ブラウザでデータを見る</h3>
<p>ブラウザ上の青い文字のところをクリックすればいろいろとプロットを作成できます．上部の紫色は，東北大学とワシントン大学の共通テーマカラーですが，嫌ならプロジェクト設定ファイルで変更できます．<a
href="ProjectSetup.html#styles">Project Setup
の章</a>に説明があります．</p>
<p>右下の Tools にある New Plot Layout
で新しい空のページを作ります．その中で，<code>Add a New Panel</code>
を選んで，<code>Time-Axis Plot</code>
を選んで，プロットを作成していきます．たぶん自明です．</p>
<p>左上の Channel List
のチャンネル名をクリックすると，直近の時系列データのプロットを含んだページが作成されます．それを元にいろいろ追加していくこともできます．</p>
<p>ここまでの準備では時系列データしか生成していないので，すぐにできるのは，それを直接プロットする
<code>Time-Axis Plot (Time-Series)</code> と，値分布のヒストグラムを作る
<code>XY Plot (Histograms and Graphs)</code> →
<code>Histogram of Time-Series Values</code> です．
以降の章で，ユーザの読み出しや解析スクリプトなどでヒストグラムやグラフなどを作成し，それらも表示するようにします．</p>
<h3 id="デバイスからデータを読む">デバイスからデータを読む</h3>
<p>SlowDash は，ウェブサーバとブラウザからなるアプリ部分と，ユーザの
Python スクリプトで利用するライブラリ部分から構成されます．
上記のダミーデータ作成では，このライブラリ (SlowPy)
を使用しました．アプリとライブラリは融合して動作しますが，それぞれを単体で使用することもできます．
この章では，SlowPy
ライブラリを単体で使用してデバイスからデータを読んで，ダミーデータ生成と置き換えます．</p>
<h4 id="準備">準備</h4>
<p>SlowPy は SlowDash
インストール時に一緒にインストールされますが，標準インストールでは venv
の中に入るので，最初にこの venv を有効にしておいてください．</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash-activate-venv</span></span></code></pre></div>
<p>これは新しいターミナルを開くごとに実行する必要があります． もし
SlowDash 専用のコンピュータを使っているなどで Python
を他に使うことがないなら，<code>.bashrc</code>
などの中に以下の行を追加しておけば毎回行う必要がなくなります．</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> <span class="va">$SLOWDASH_DIR</span>/venv/bin/activate</span></code></pre></div>
<h4 id="対象デバイス">対象デバイス</h4>
<p>ここでは，広く使われていてネットワーク制御が可能な電圧計（マルチメータ）から直流電圧を読み出す例を作成します．
多くの電圧計が同じコマンドを使いますが，特に以下のものについてはコマンドを確認してあります（ChatGPT
調べ，2025年8月）：</p>
<table>
<thead>
<tr class="header">
<th>メーカー</th>
<th>モデル</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Keysight / Agilent</td>
<td>34460A DMM</td>
</tr>
<tr class="even">
<td>Tektronics / Keithley</td>
<td>DMM6500</td>
</tr>
<tr class="odd">
<td>Rigol</td>
<td>DM3058</td>
</tr>
<tr class="even">
<td>BK Precision</td>
<td>5492B DMM</td>
</tr>
</tbody>
</table>
<p>また，多くの電源モジュールも，出力電圧の読み出しで同じコマンドを使用します．なので，この例で同様に使用できます．
以下は確認済のモデルです（ChatGPT 調べ，2025年8月）</p>
<table>
<thead>
<tr class="header">
<th>メーカー</th>
<th>モデル</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Keysight / Agilent</td>
<td>E363x/E364x</td>
</tr>
<tr class="even">
<td>Tektronics / Keithley</td>
<td>2230G/2231A</td>
</tr>
<tr class="odd">
<td>Rhode&amp;Schwarz</td>
<td>NGA100 など</td>
</tr>
<tr class="even">
<td>Rigol</td>
<td>DP800, DP2000</td>
</tr>
<tr class="odd">
<td>BK Precision</td>
<td>9180/9190</td>
</tr>
</tbody>
</table>
<p>これらのデバイスは全てイーサーネット経由でコントロールできるものです．
次の手順に進む前に，ネットワークに接続し，電源を入れて，IP
アドレス（と念の為ポート番号；マニュアルに書いてあります）を確認しておいてください．</p>
<h4 id="使えるデバイスがない場合">使えるデバイスがない場合</h4>
<p>ChatGPT
によると，ほとんどの電圧計と電源ユニットでは，ここで使うレベルのコマンドは共通らしいです．
もしいずれのデバイスも利用できない場合は，SlowDash
にシミュレータがあるので，代わりにこれを使用して例を実行することができます．
新しいターミナルを開いて，以下のコマンドを実行してください．</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash-activate-venv</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH/utils</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">$ python ./dummy-scpi.py</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>listening at 172.26.0.1:5025</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>line terminator is: x0d</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>type Ctrl-c to stop</span></code></pre></div>
<p>これで，このデバイスがネットワーク上にあるように振る舞います．使われる
IP アドレスはローカルホストのものです． 終了は Ctrl-c
を押してください．</p>
<h4 id="デバイスからの読み出し">デバイスからの読み出し</h4>
<p>上記のデバイスは全て，SCPI
と呼ばれる単純なテキストコマンド体系を使用します． 以下は，ここで使う
SCPI コマンドです．</p>
<table>
<colgroup>
<col style="width: 20%" />
<col style="width: 45%" />
<col style="width: 35%" />
</colgroup>
<thead>
<tr class="header">
<th>動作</th>
<th>コマンド</th>
<th>戻り値例</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>デバイスIDの取得</td>
<td><code>*IDN?</code></td>
<td><code>Keysight Technologies,34460A...</code> みたいな感じ</td>
</tr>
<tr class="even">
<td>設定リセット</td>
<td><code>*RST</code></td>
<td>たぶんなし</td>
</tr>
<tr class="odd">
<td>DC 電圧値の読み出し</td>
<td><code>MEAS:VOLT:DC?</code></td>
<td><code>3.24</code> みたいな感じ</td>
</tr>
</tbody>
</table>
<p>SlowPy
ライブラリでは，デバイスの論理構造を反映させたツリーをまず構築します．
この例では，[測定システム] -&gt; [イーサーネット] -&gt; [SCPI
コントロール] -&gt; [各コマンド] のような形をしています．
そして，それぞれのツリーのノードに対して値の読み書きを
<code>set(value)</code> または <code>value=get()</code> により行います．
例えば，以下の２行で，SlowPy
を使用して，上記のデバイスからデバイスIDを取得して表示します．</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> control_system <span class="im">as</span> ctrl</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ctrl.ethernet(<span class="st">&#39;172.26.0.1&#39;</span>, <span class="dv">5025</span>).scpi().command(<span class="st">&#39;*IDN?&#39;</span>).get())</span></code></pre></div>
<p>デバイスのアドレスとポート番号は適宜書き換えてください．
この時点でデバイスとの接続確認ができます．</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash-activate-venv</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ python read-my.py</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>Keysight Technologies,34460A...</span></code></pre></div>
<p>コマンド発行ごとに毎回ツリーを構築しても構いませんが（その度にネットワークコネクションが再作成されることはありません），通常はデバイスレベルで切って変数に保存すると便利です．</p>
<p>以下は，最初に設定リセットをして，1
秒ごとのデータ読み出しを永遠に続ける完全な例です．</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> control_system <span class="im">as</span> ctrl</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> ctrl.ethernet(<span class="st">&#39;172.26.0.1&#39;</span>, <span class="dv">5025</span>).scpi()</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>device.command(<span class="st">&#39;*RST&#39;</span>).<span class="bu">set</span>()</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    volt <span class="op">=</span> device.command(<span class="st">&#39;MEAS:VOLT:DC?&#39;</span>).get()</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(volt)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    ctrl.sleep(<span class="dv">1</span>)</span></code></pre></div>
<p>（<code>ctrl.sleep()</code> は，ここの時点では
<code>time.sleep()</code>
と同じです．この後で，シグナルなどによりループを止めようとしたときに小さな差が出ます．）</p>
<p>SlowPy はデータベース読み書きの機能も提供しています．
以下は，画面への print の代わりにデータベース（この例では
SQLite）に記録するようにした完全な例です．</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> control_system <span class="im">as</span> ctrl</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> ctrl.ethernet(<span class="st">&#39;172.26.0.1&#39;</span>, <span class="dv">5025</span>).scpi()</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.store <span class="im">import</span> DataStore_SQLite</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>datastore <span class="op">=</span> DataStore_SQLite(<span class="st">&#39;sqlite:///TestData.db&#39;</span>, table<span class="op">=</span><span class="st">&quot;slowdata&quot;</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>device.command(<span class="st">&#39;*RST&#39;</span>).<span class="bu">set</span>()</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    volt <span class="op">=</span> device.command(<span class="st">&#39;MEAS:VOLT:DC?&#39;</span>).get()</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    datastore.append({<span class="st">&#39;volt&#39;</span>: volt})</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    ctrl.sleep(<span class="dv">1</span>)</span></code></pre></div>
<p>これをダミーデータ生成プログラムの代わりに走らせれば，実データに対して
SlowDash を使えるようになります． この時点では，停止に
<code>Ctrl-c</code> または <code>Ctrl-\</code> が必要です．
見苦しいことになると思いますが，実害はないはずです．</p>
<h4
id="読み出しスクリプトを-slowdash-アプリに統合する">読み出しスクリプトを
SlowDash アプリに統合する</h4>
<p>任意の Python スクリプト(SlowPyを使う必要もない)を SlowDash
プロジェクトディレクトリの下の <code>config</code>
ディレクトリ（すでに自動作成されているはず）に
<code>slowtask-XXX.py</code> という名前で保存すると，SlowDash
ホーム画面の左下の “SlowTask”
セクションに作成したスクリプトが表示され，コントロールできるようになります．
<code>SlowdashProject.yaml</code>
の設定で，スクリプトを自動開始するようにしたり，ブラウザからこの Python
ファイルを直接編集できるようにすることもできます．具体的な手順は，公式ドキュメントを参照してください．</p>
<p>ただし，上記のスクリプトは，（上品に）停止させるためのコードがありません．アプリ側から停止や再実行をできるようにするためには，アプリからのコントロールを受けられるようにする必要があります．そのために，以下のように
SlowDash で規定されているコールバックを実装します．</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> control_system <span class="im">as</span> ctrl</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> ctrl.ethernet(<span class="st">&#39;172.26.0.1&#39;</span>, <span class="dv">5025</span>).scpi()</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.store <span class="im">import</span> DataStore_SQLite</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>datastore <span class="op">=</span> DataStore_SQLite(<span class="st">&#39;sqlite:///QuickTourTestData.db&#39;</span>, table<span class="op">=</span><span class="st">&quot;testdata&quot;</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>device.command(<span class="st">&#39;*RST&#39;</span>).<span class="bu">set</span>()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _loop():</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    volt <span class="op">=</span> device.command(<span class="st">&#39;MEAS:VOLT:DC?&#39;</span>).get()</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    datastore.append({<span class="st">&#39;volt&#39;</span>: volt})</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    ctrl.sleep(<span class="dv">1</span>)</span></code></pre></div>
<p><code>while True</code> を <code>def _loop()</code>
に置き換えただけです． SlowDash がこのスクリプトを実行している間は
<code>_loop()</code> 関数が繰り返し呼び出されます．</p>
<p>他にも <code>_initialize()</code>
などのコールバック関数があります．詳しくは公式ドキュメントの「Control
Script」の章を参照してください．
スレッド構造や非同期実行オプションなどの詳細も書かれています．</p>
<p>このスクリプトの末尾に以下のブロックを追加しておくと，これを単独実行できるようになります．</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="va">True</span>:</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>      _loop()</span></code></pre></div>
<p>さらにひと手間かけて，以下のようにすると，単独実行の際に Ctrl-c
で上品に止まるようになります．</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&#39;__main__&#39;</span>:</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    ctrl.stop_by_signal()</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="kw">not</span> ctrl.is_stop_requested():</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        _loop()</span></code></pre></div>
<p>ここまでを行った例が
<code>ExampleProjects/QuickTour/RealDevice</code> にあります． Python
読み出しスクリプトはその下の <code>config</code> においてあります．</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH/ExampleProjects/QuickTour/RealDevice</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash --port=18881</span></span></code></pre></div>
<p>ブラウザを開いて <code>http://localhost:18881</code>
にアクセスすると，左下の “SlowTask” セクションに “read-my”
が表示されてそこから [start] と [stop] ができます．</p>
<p>単体実行はいままでどおりです：</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash-activate-venv</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ python config/slowtask-read-my.py</span></span></code></pre></div>
<h4 id="追加の詳細">追加の詳細</h4>
<p>電源ユニットを使用する場合で，出力電圧を設定するには以下のようにします．</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> control_system <span class="im">as</span> ctrl</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> ctrl.ethernet(<span class="st">&#39;172.26.0.1&#39;</span>, <span class="dv">5025</span>).scpi(append_opc<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>device.command(<span class="st">&#39;VOLT&#39;</span>).<span class="bu">set</span>(<span class="fl">3.0</span>)    <span class="co"># this will send &quot;VOLT 3.0; *OPC?&quot;</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>device.command(<span class="st">&#39;OUTP&#39;</span>).<span class="bu">set</span>(<span class="st">&#39;ON&#39;</span>)   <span class="co"># this will send &quot;OUTP ON; *OPC?&quot;</span></span></code></pre></div>
<p>SlowPy
では，全てのコマンドに戻り値があることを期待するので，戻り値のないコマンドが存在するようなデバイスでは，コマンドの完了を待ってそのステータスをかえすコマンド
<code>*OPC?</code>
を付加する必要があります．常に戻り値があるようなデバイスに
<code>*OPC?</code> を付加しても，通常は無害です． 上記の例では，全ての
set() に <code>*OPC?</code> を付加するように，<code>scpi()</code>
ノード自体にオプションを設定しています． （もともと戻り値のある get()
には付加されません．）
もしコマンドごとに切り替えたいなら，自分でコマンドに <code>*OPC?</code>
を付加しても全く構いません．</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>device.command(<span class="st">&#39;OUTP ON; *OPC?&#39;</span>).<span class="bu">set</span>()</span></code></pre></div>
<p>イーサーネットではなく，USB や RS-232
などでコントロールするデバイスに対しては，デバイスツリーの対応する部分を置き換えます．
例えば，USB 接続を VISA
経由で使用するデバイスでは，以下のようになります．</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> control_system <span class="im">as</span> ctrl</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>ctrl.load_control_module(<span class="st">&#39;VISA&#39;</span>)    <span class="co"># VISA は SlowPy プラグインとして提供されているので load する</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> ctrl.visa(<span class="st">&#39;USB00::0x2A8D::0x201:MY54700218::00::INSTR&#39;</span>).scpi()</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>(あとは同じ)</span></code></pre></div>
<p><code>visa()</code> の引数（VISA アドレス:
ベンダ/モデル/シリアル番号を含む）は多くのデバイスで設定画面に表示されます．</p>
<p>イーサーネット経由で SCPI を使うデバイスでも，HiSLIP
などを使う場合は，VISA
経由で使用してください．<code>TPCIP0::&lt;IPアドレス&gt;::hislip0</code>
みたいなアドレスになると思います．</p>
<h4 id="この先">この先</h4>
<ul>
<li><code>SlowdashProject.yaml</code> に <code>task</code>
のエントリを作ると，スクリプトの自動実行を設定できます．</li>
<li><code>SlowdashProject.yaml</code> に
セキュリティ設定をすると，スクリプトをブラウザから編集できるようにできます．</li>
<li>ブラウザに入力エリアやボタンを配置して，ボタンクリックでスクリプト中の任意の関数を呼び出すようにすることができます．</li>
<li>スクリプト中でヒストグラムやグラフを作成して，データベースに保存したりブラウザにストリーミングすることができます．</li>
</ul>
<p>これらの手順については，公式ドキュメントの「プロジェクト設定」や「コントロールスクリプト」の章を参照してください．</p>
<h3 id="おまけraspberry-pi-を-scpi-デバイスにする">おまけ：Raspberry-Pi
を SCPI デバイスにする</h3>
<p>SlowPy ライブラリには SCPI
のサーバー側インターフェースの機能も含まれているので，これを使えば任意の
Python プログラムに SCPI を実装し，SlowDash
のデータ保存やモニタ，コントロールなどに直接接続できます．</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slowpy.control <span class="im">import</span> ScpiServer, ScpiAdapter</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MyDevice(ScpiAdapter):</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(idn<span class="op">=</span><span class="st">&#39;MyDevice&#39;</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> do_command(<span class="va">self</span>, cmd_path, params):</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># cmd_path: 文字列の配列．SCPI のコマンド部分を大文字にして : で区切ったもの．</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># params: 文字列の配列．SCPI のパラメータ部分を大文字にして , で区切ったもの．</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cmd_path[<span class="dv">0</span>].startswith(<span class="st">&#39;DATA&#39;</span>):</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> データ値</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> ...</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>            ...</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>    <span class="co"># 知らないコマンドだった場合</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> MyDevice()</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>server <span class="op">=</span> ScpiServer(device, port<span class="op">=</span><span class="dv">5025</span>)</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>server.start()</span></code></pre></div>
<p><code>do_command()</code>
の中でコマンドを読んで値を返すだけです．返り値がない場合は空文字
<code>""</code> を返してください． 無効なコマンドの場合は
<code>None</code> を返してください． <code>*IDN?</code> や
<code>*OPC?</code>
などの一部の標準コマンドは親クラスで実装されています． SCPI
のコマンド連結なども親クラスで処理されます．</p>
<p><code>/etc/rc.local</code>
などを使って作成したスクリプトをシステム起動時に自動で実行するようにすれば，これが
SCPI デバイスとして使えるようになります．</p>
<h1 id="docker-コンテナで使う">Docker コンテナで使う</h1>
<h3 id="基本">基本</h3>
<p>DockerHub と GitHub に SlowDash
のコンテナイメージがあります．どちらも同じです．</p>
<ul>
<li>DockerHub: <a
href="https://hub.docker.com/r/slowproj/slowdash/tags">slowproj/slowdash:TAG</a></li>
<li>GitHub Container Registry: <a
href="https://github.com/slowproj/slowdash/pkgs/container/slowdash">ghcr.io/slowproj/slowdash:TAG</a></li>
</ul>
<p>コンテナ内での SlowDash プロジェクトディレクトリは
<code>/project</code>
です．これをボリュームマウントして使ってください．以下は，<code>SlowdashProject.yaml</code>
ファイルが作ってあるプロジェクトディレクトリからコンテナの SlowDash
サーバーを実行する例です．</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker run --rm -p 18881:18881 -v $(pwd):/project slowproj/slowdash</span></span></code></pre></div>
<p>毎回打つのは大変なので，<code>docker-compose.yaml</code>
を使うのが簡単です．SlowDash の <code>ExampleProjects</code>
以下にあるプロジェクト例には，すべて <code>docker-compose.yaml</code>
ファイルが含まれています．</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">slowdash</span><span class="kw">:</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> slowproj/slowdash</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> .:/project</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;18881:18881&quot;</span></span></code></pre></div>
<p>このファイルがある場所で <code>docker compose up</code>
とすればイメージがダウンロードされ，実行が開始されます．（初回は少し時間がかかります．）</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker compose up</span></span></code></pre></div>
<p>SlowDash のコマンドを使用したい場合，<code>docker run</code> または
<code>docker compose up</code>
でコンテナを走らせてから，<code>docker exec</code>
でコンテナの中から実行してください．</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker ps</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>CONTAINER ID   IMAGE         COMMAND                   CREATED          STATUS         PORTS       NAMES</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>70e0b99483ae   slowdash      &quot;/slowdash/app/docke…&quot;   10 seconds ago   Up 9 seconds   18881/tcp   elastic_jackson</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker exec -it 70e    slowdash config -i4       （70e は上の行で表示されているコンテナID； -i4 は整形オプション）</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    &quot;slowdash&quot;: {</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>        &quot;version&quot;: &quot;250128 \&quot;Skykomish\&quot;&quot;</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
<h1 id="slowdash-のアップデート">SlowDash のアップデート</h1>
<h2 id="直接インストール">直接インストール</h2>
<p>Make を使って更新をできます：</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ make update</span></span></code></pre></div>
<p>手動で行う場合は，<code>git pull</code>
の際に<code>--recurse-submodule</code>
を忘れないようにしてください．</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ git pull --recurse-submodules</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="kw">$ make</span></span></code></pre></div>
<p>この <code>--recurse-submodules</code>
を忘れることがとても多いです．そして，その場合には，異なるバージョンのソースが混ざるので，それに気づかないとデバッグがとても難しくなります．上記の
<code>make update</code> を使うのがおすすめです．</p>
<h2 id="docker-コンテナ">Docker コンテナ</h2>
<p>latest タグの SlowDash
コンテナを使っている場合，<code>docker pull</code>
コマンドで最新のものに置き換えることができます．</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker pull slowproj/slowdash</span></span></code></pre></div>
<p>または，compose のディレクトリから compose
コマンドで行うこともできます．</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker compose pull</span></span></code></pre></div>
<p>使用中の SlowDash バージョンが SlowDash
のホーム画面の左上に表示されているので，ここでちゃんと更新されたかを確認できます．</p>
<h1 id="動作確認用テスト環境">動作確認用テスト環境</h1>
<p>SlowDash が頻繁に利用するデータベースや Jupyter
などを集めたコンテナが <code>slowdash/utils/testbench</code>
にあります．
システム開発時に本番用のデータベースを使いたくない場合や，開発用サーバのインストールが面倒な場合に，すぐに使えてすぐに消せて便利です．</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ cd PATH/TO/SLOWDASH/utils/testbench</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker compose up</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="kw">$ docker compose down   （終了後データを消す）</span></span></code></pre></div>
<p>PostgreSQL, MySQL, InfluxDB, Redis, MQTT, Jupyter
などがすべて使えるようになります．
（これらがすでに走っている場合は，ポートが衝突してエラーになるので，コメントアウトかポート番号の変更が必要です．）</p>
<p>このテスト環境は，SlowDash
自体がコンテナに入っていなくても（直接実行でも）使えます． SlowDash
をコンテナ内で使用する場合でも，設定ファイルやスクリプトの開発はコンテナの外で（SlowDash
だけはターミナルで直接実行）して，ある程度完成してからコンテナに入れた方が，変更のたびにコンテナの再起動をしなくて済むので楽です．</p>
<h1 id="セキュリティについて">セキュリティについて</h1>
<p><b>SlowDash
は，ファイアウォールの内部で使う目的で作られています．</b>
このためセキュリティ関係の機能は実装されていません．SlowDash
のポートを外部からアクセスできるところに開けないようにしてください．外部からは，VPN
もしくは SSH のトンネルを経由して使用するのが想定です．</p>
<h3 id="基本認証">基本認証</h3>
<p>もし内部の人を信用できない場合，最低限として，基本認証を使ってパスワードを設定することはできます．
<code>SlowdashProject.yaml</code> に <code>authentication</code>
エントリを追加し，パスワードハッシュを指定してください．</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">slowdash_project</span><span class="kw">:</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="at">  ...</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">authentication</span><span class="kw">:</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">type</span><span class="kw">:</span><span class="at"> Basic</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">key</span><span class="kw">:</span><span class="at"> slow:$2a$12$UWLc20NG5E3drX35cfA/5eFxuDVC0U79dGg4UP/mo55cj222/vuRS</span></span></code></pre></div>
<p>パスワードハッシュは，Apache の bcrypt
と同じ形式ですが，<code>slowdash/utils</code> にある
<code>slowdash-generate-key.py</code>
プログラムで作ることもできます．</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ python3 PATH/TO/SLOWDASH/utils/slowdash-generate-key.py slow dash</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    &quot;type&quot;: &quot;Basic&quot;,</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    &quot;key&quot;: &quot;slow:$2a$12$UWLc20NG5E3drX35cfA/5eFxuDVC0U79dGg4UP/mo55cj222/vuRS&quot;</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>ここでのパスワードは，暗号化せずにやりとりされるので，基本認証を使う場合は
HTTPS を使って通信を暗号化する必要があります．
これは，外部のリバースプロキシを使って行うことが想定されています．</p>
<p>SlowDash をデフォルトの ASGI
モードで使っている場合は，リバースプロキシの代わりに，組み込みの HTTPS
サーバーを使うこともできます．SSL/TLS 鍵ファイルと認証ファイルを指定して
<code>slowdash</code> を起動してください．</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ slowdash  --port=18881  --ssl-keyfile=KEY_FILE  --ssl-certfile=CERT_FILE</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>Listening at port 18881 (ASGI HTTPS)</span></code></pre></div>
<p>ただし，この機能は将来の SlowDash
では削除されるかもしれません．長期使用するシステムでは，ちゃんとしたリバースプロキシを使用するのがいいと思います．</p>
<h1 id="リバースプロキシ">リバースプロキシ</h1>
<p>SlowDash はデフォルトで暗号化されていない HTTP/1.1
を使用します．これに，Nginx や Apache
などの外部のリバースプロキシを接続し，HTTP/2
などに乗せ替えることで，通信を暗号化し，また，ブラウザとの間で HTTP/2
の効率的な通信を使用できるようになります．通常，ここが通信上のボトルネックで，これをするとレスポンスがかなり良くなることが多いです．（SlowDash
に HTTP/2
を喋らせることもできますが，広く使われているリバースプロキシを使用する方がトラブルに遭遇したときの対処が楽です．）</p>
<h3 id="docker-compose">Docker Compose</h3>
<p>SlowDash を Docker Compose で使う場合，その中に Nginx または Apache
を含めてリバースプロキシとする例が
<code>ExampleProjects/ReverseProxy</code>
にあります．多くの場合，証明書類を置き換えるだけでそのまま使えるはずです．</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">services</span><span class="kw">:</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">nginx</span><span class="kw">:</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">build</span><span class="kw">:</span><span class="at"> ./nginx</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">ports</span><span class="kw">:</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;80:80&quot;</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;443:443&quot;</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">depends_on</span><span class="kw">:</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> slowdash</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">slowdash</span><span class="kw">:</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">image</span><span class="kw">:</span><span class="at"> slowproj/slowdash</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">expose</span><span class="kw">:</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;18881&quot;</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">volumes</span><span class="kw">:</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> .:/project</span></span></code></pre></div>
<p>ここでは SlowDash
のポートは外部に接続されていないことに注意してください．</p>
<p><code>ExampleProjects/ReverseProxy/Nginx</code>
の下には，<code>nginx</code> という名前で Nginx
の設定ファイルがあります（Apache の方もほぼ同様です）．</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode console"><code class="sourceCode highlightconsole"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">$ tree Nginx</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>Nginx/</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>├── SlowdashProject.yaml</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>├── docker-compose.yaml</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>└── nginx</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    ├── Dockerfile</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    ├── certs</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    │   ├── fullchain.pem</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    │   └── privkey.pem</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    ├── default.conf</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    ├── generate-htpasswd.sh</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    ├── generate-selfsigned-certificates.sh</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    └── htpasswd</span></code></pre></div>
<p>使用する前に，<code>nginx</code>
サブディレクトリもコピーし，さらに，その下の <code>certs</code>
に証明書類を，<code>htpassword</code>
ファイルにパスワードを設定しておいてください． <code>htpassword</code>
の中身は，基本認証の <code>"key"</code> の値の一行です（上記の例で
<code>slow:</code> から始まる部分）．
内部使用のためのオレオレ証明書を，<code>generate-selfsigned-certificates.sh</code>
により作成できます． (ホスト名が外部から解決できる場合は Let’s Encrypt
でちゃんとした証明書を無料で取得できます．その瞬間だけ外部からアクセスできるようにして，SlowDash
を走らせる前に閉めるという方法もあるようです．）</p>
<p>準備ができたら，<code>docker compose up --build</code>
して，ブラウザから <code>https://localhost/slowdash/</code>
にアクセスしてください．（<code>--build</code>
オプションは，パスワードや設定ファイルを変更した場合だけ必要です．）</p>
<h3 id="直接インストール-1">直接インストール</h3>
<p>SlowDash にコンテナを使っていない場合でも，リバースプロキシだけを
Docker で動かすこともできます．この場合の設定は，すべてを Docker Compose
で使う場合とほぼ同じになります (<code>docker-compose.yaml</code> の
slowdash を削除し，<code>nginx/defaults.conf</code> の
<code>proxy_pass</code> をホストマシンにする)．SlowDash
のポートが外部から直接アクセスできないようにファイアーウォールを設定してください．</p>
<p>すべてを Docker
でない環境で使う場合の設定方法は，使用している環境に合わせた方法を AI
が詳しく教えてくれます．SlowDash では ASGI
インターフェースが利用可能で，同じポート番号で WebSockets
も使っている旨を伝えれば，設定ファイルを一通り書いてくれます．暗号化していないもとのポートを塞いでおくのを忘れないでください．参考までに，上記の例で
Nginx を Docker Compose
内でリバースプロキシとして使用する場合の設定ファイルを示します．だいたい似たような感じになると思います．</p>
<pre class="conf"><code>server {
    listen 443 ssl;
    http2 on;
    server_name localhost;   # これは自分のホスト名に変える

    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers EECDH+AESGCM:EDH+AESGCM;
    ssl_prefer_server_ciphers off;

    auth_basic &quot;SlowDash Password Required&quot;;
    auth_basic_user_file /etc/nginx/.htpasswd;

    location /slowdash/ {
        proxy_pass http://slowdash:18881/;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection &quot;upgrade&quot;;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SlowDash では Long Polling を使っているので，タイムアウトは長くする
        proxy_read_timeout 8640000s;  # 1000 days for long polling used in SlowDash
        proxy_send_timeout 8640000s;  # 1000 days for long polling used in SlowDash
        proxy_connect_timeout 10s;
    }
}

# HTTP への接続は HTTPS に転送する
server {
    listen 80;
    server_name localhost;
    return 301 https://$host$request_uri;
}</code></pre>
<div style="margin-bottom:10rem"/>



</body>
</html>
